\# QFEngine â€” ç²¾ç¡®å¤æƒ Â· å¯ä¿¡å›æµ‹ Â· æ™ºèƒ½é€‰è‚¡



> ä¸€ä¸ªé¢å‘é‡åŒ–ç ”ç©¶ä¸å®ç›˜æ¨¡æ‹Ÿçš„è½»é‡çº§ Python å¼•æ“ï¼Œ  

> æ ¸å¿ƒç‰¹è‰²ï¼š\*\*æ•°å­¦ä¿çœŸçš„ä»·æ ¼å¤æƒ + å¯å®¡è®¡çš„äº¤æ˜“è®°å½• + è‚¡ç¥¨æ± é©±åŠ¨çš„ç­–ç•¥æ¡†æ¶\*\*ã€‚



---



\## âœ¨ æ ¸å¿ƒç‰¹æ€§



\- \*\*ç²¾ç¡®å¤æƒï¼ˆQFQ / HFQï¼‰\*\*  

&nbsp; åŸºäºæ€»å›æŠ¥ç‡é‡å»ºä»·æ ¼åºåˆ—ï¼Œç¡®ä¿æ¯æ—¥æ¶¨è·Œå¹… = çœŸå®æ”¶ç›Šï¼Œæœç»ä¼ ç»Ÿå› å­æ³•çš„ç´¯ç§¯è¯¯å·®ã€‚

&nbsp; 

\- \*\*äº‹ä»¶é©±åŠ¨å›æµ‹å¼•æ“\*\*  

&nbsp; æ”¯æŒæŒ‰æ—¥è°ƒåº¦ã€åŠ¨æ€è°ƒä»“ã€æŒä»“ç®¡ç†ã€ç»©æ•ˆè®¡ç®—ï¼ˆå¹´åŒ–æ”¶ç›Šã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡ã€èƒœç‡ç­‰ï¼‰ã€‚



\- \*\*è‚¡ç¥¨æ± ï¼ˆStock Poolï¼‰æœºåˆ¶\*\*  

&nbsp; å¤–éƒ¨æ³¨å…¥å€™é€‰è‚¡ç¥¨åˆ—è¡¨ï¼Œæ”¯æŒâ€œä¿¡å·æ—¥ â†’ äº¤æ˜“æ—¥â€å»¶è¿Ÿæ‰§è¡Œï¼Œè´´è¿‘å®ç›˜é€»è¾‘ã€‚



\- \*\*ç»“æ„åŒ–äº¤æ˜“è®°å½•\*\*  

&nbsp; æ‰€æœ‰æˆäº¤æŒ‰æ—¥æœŸç´¢å¼•å­˜å‚¨ï¼Œä¾¿äºäº‹ååˆ†æä¸å¯è§†åŒ–ã€‚



---



\## ğŸ“¦ å®‰è£…



ä»æºç å®‰è£…ï¼ˆå¼€å‘æ¨¡å¼ï¼‰ï¼š

```bash

git clone https://github.com/chenwenwai/qfengine.git

cd qfengine

pip install -e .





ä¾èµ–ï¼špandas >= 1.3, numpy >= 1.20





å¿«é€Ÿå¼€å§‹



1\. æ•°æ®å‡†å¤‡

ä½ çš„è¡Œæƒ…æ•°æ®éœ€åŒ…å«ä»¥ä¸‹å­—æ®µï¼ˆDataFrameï¼‰ï¼š



å­—æ®µ                                             è¯´æ˜

date                                            äº¤æ˜“æ—¥ï¼ˆdatetimeï¼‰

symbol                                       è‚¡ç¥¨ä»£ç ï¼ˆstrï¼‰

open, high, low, close              OHLC ä»·æ ¼

è‚¡æƒç³»æ•°                                      é™¤æƒå› å­ï¼ˆå¦‚ 10é€5 â†’ 1.5ï¼›æ— åˆ†çº¢å¡« 1ï¼‰

æ´¾æ¯ç³»æ•°                                      æ´¾æ¯é‡‘é¢ï¼ˆå…ƒ/è‚¡ï¼›æ— æ´¾æ¯å¡« 0ï¼‰



&nbsp;åˆ†çº¢äº‹ä»¶éœ€æå‰åˆå¹¶åˆ°è¡Œæƒ…è¡¨ä¸­ï¼ˆåŒæ—¥æœŸå¯¹é½ï¼‰ã€‚



2\. è®¡ç®—å¤æƒä»·æ ¼

import pandas as pd

from qfengine import make\_qfq, make\_hfq



\# æŒ‰è‚¡ç¥¨åˆ†ç»„å¤æƒ

df\_qfq = df.groupby('symbol').apply(make\_qfq).reset\_index(drop=True)    #  è¿”å›å‘åå¤æƒä»·æ ¼

df\_hfq = df.groupby('symbol').apply(make\_hfq).reset\_index(drop=True)    #  è¿”å›å‘å‰å¤æƒä»·æ ¼



3\. è¿è¡Œå›æµ‹

from qfengine.backtest import BacktestEngine

\# ç”¨æˆ·å†™ç­–ç•¥å‡½æ•°ï¼Œcontextæ˜¯å…¨å±€å¯¹è±¡ï¼Œrun\_funcæ˜¯å‡½æ•°åï¼Œæ˜¯å¼•æ“è§„å®šçš„ï¼Œå¿…é¡»æŒ‰è§„å®šæ ¼å¼å†™

def run\_func(context):

&nbsp;	pass

\#   è°ƒç”¨å›æµ‹å¼•æ“ï¼Œstart\_dateæ˜¯å›æµ‹å¼€å§‹æ—¥æœŸï¼Œend\_dateæ˜¯å›æµ‹ç»“æŸæ—¥æœŸï¼ŒÂ dataæ˜¯ä¼ å…¥çš„æ•°æ®ï¼ŒÂ run\_funcæ˜¯ç­–ç•¥å‡½æ•°ã€‚

context = BacktestEngine(start\_date, end\_date, data, run\_func)





&nbsp; å›æµ‹è¾“å‡ºç¤ºä¾‹

Total Return: 15.88%

Annualized Return: 16.66%

Max Drawdown: -12.81%

Sharpe Ratio: 0.79

Win Rate: 20.00%



&nbsp; é¡¹ç›®ç»“æ„

qfengine/

â”œâ”€â”€ data/          # å¤æƒæ¨¡å—

â”‚   â””â”€â”€ adjust.py  # make\_qfq, make\_hfq

â”œâ”€â”€ backtest/      # å›æµ‹å¼•æ“

â”‚   â””â”€â”€ engine.py  # BacktestEngine ç±»

â””â”€â”€ \_\_init\_\_.py    # ç»Ÿä¸€å¯¼å‡ºæ¥å£





&nbsp; è´¡çŒ®ä¸æ‰©å±•

æ¬¢è¿æäº¤ Issue æˆ– PRï¼

&nbsp;å½“å‰å¯æ‰©å±•æ–¹å‘ï¼š

æ”¯æŒå¤šå› å­é€‰è‚¡

é›†æˆ AKShare / Tushare æ•°æ®è‡ªåŠ¨ä¸‹è½½

æ·»åŠ å‡€å€¼æ›²çº¿ç»˜å›¾åŠŸèƒ½



&nbsp; License

MIT Â© \[chenwenwai]





**å¤æƒæ•°æ®å‡†å¤‡è¯´æ˜ï¼š**

1ã€åŸå§‹å†å²æœªå¤æƒè¡Œæƒ…æ•°æ®

2ã€å¯¹åº”æ—¶é—´æ®µçš„å†å²åˆ†çº¢æ•°æ®ï¼Œå¯ä»¥ä»akshareè·å–

3ã€ä»£ç ç¤ºä¾‹:



def merge\_price\_with\_dividend\_events(df\_price, df\_dividend):

&nbsp;   """

&nbsp;   å°†æœªå¤æƒè¡Œæƒ…æ•°æ®ä¸åˆ†çº¢é€è‚¡äº‹ä»¶æ•°æ®æŒ‰ã€Œé™¤æƒæ—¥ã€è¿›è¡Œå·¦è¿æ¥ï¼ˆleft joinï¼‰ï¼Œ

&nbsp;   ç”¨äºåç»­å¤æƒä»·æ ¼è®¡ç®—ã€‚åˆ†çº¢é€è‚¡äº‹ä»¶æ•°æ®è¦è¿›è¡Œå¿…è¦çš„æ¸…æ´—ï¼Œå¿…é¡»è¦æœ‰è‚¡ç¥¨ä»£ç symbolåˆ—

&nbsp;   Parameters:

&nbsp;   ----------

&nbsp;   df\_price : pd.DataFrame

&nbsp;       æœªå¤æƒè¡Œæƒ…æ•°æ®ï¼Œå¿…é¡»åŒ…å«åˆ—: \['date', 'symbol', 'open', 'high', 'low', 'close']

&nbsp;   df\_dividend : pd.DataFrame

&nbsp;       åˆ†çº¢é€è‚¡äº‹ä»¶æ•°æ®ï¼Œå¿…é¡»åŒ…å«åˆ—: \['date' (å³é™¤æƒæ—¥), 'symbol',

&nbsp;                                   'é€è‚¡æ¯”ä¾‹', 'è½¬å¢æ¯”ä¾‹', 'æ´¾æ¯æ¯”ä¾‹']

&nbsp;   Returns:

&nbsp;   -------

&nbsp;   pd.DataFrame

&nbsp;       åˆå¹¶åçš„æ•°æ®ï¼Œæ–°å¢åˆ—: 'è‚¡æƒç³»æ•°', 'æ´¾æ¯ç³»æ•°'ï¼Œæ— é™¤æƒæ—¥çš„è¡Œå°†å¡«å……ä¸º1å’Œ0ã€‚

&nbsp;   """

&nbsp;   # åˆå§‹åŒ–å¤„ç†

&nbsp;   df\_dividend.rename(columns={'é™¤æƒæ—¥': 'date'}, inplace=True)

&nbsp;   df\_dividend.sort\_values(by='date', inplace=True)

&nbsp;   # å¤„ç†ç¼ºå¤±å€¼

&nbsp;   df\_dividend\['é€è‚¡æ¯”ä¾‹'] = df\_dividend\['é€è‚¡æ¯”ä¾‹'].fillna(0)

&nbsp;   df\_dividend\['è½¬å¢æ¯”ä¾‹'] = df\_dividend\['è½¬å¢æ¯”ä¾‹'].fillna(0)

&nbsp;   df\_dividend\['æ´¾æ¯æ¯”ä¾‹'] = df\_dividend\['æ´¾æ¯æ¯”ä¾‹'].fillna(0)



&nbsp;   # è®¡ç®—å¤æƒæ‰€éœ€ç³»æ•°

&nbsp;   df\_dividend\['è‚¡æƒç³»æ•°'] = (df\_dividend\['é€è‚¡æ¯”ä¾‹'] + df\_dividend\['è½¬å¢æ¯”ä¾‹']) / 10.0 + 1.0

&nbsp;   df\_dividend\['æ´¾æ¯ç³»æ•°'] = df\_dividend\['æ´¾æ¯æ¯”ä¾‹'] / 10.0



&nbsp;   # ä¿ç•™å¿…è¦åˆ—

&nbsp;   df\_dividend = df\_dividend\[\['date', 'symbol', 'è‚¡æƒç³»æ•°', 'æ´¾æ¯ç³»æ•°']].copy()



&nbsp;   # ç¡®ä¿ date æ˜¯ datetime

&nbsp;   df\_dividend\['date'] = pd.to\_datetime(df\_dividend\['date'])

&nbsp;   df\_price = df\_price.copy()

&nbsp;   df\_price\['date'] = pd.to\_datetime(df\_price\['date'])



&nbsp;   # å·¦è¿æ¥ï¼šä¿ç•™æ‰€æœ‰è¡Œæƒ…æ—¥ï¼Œäº‹ä»¶æ—¥ä¸å­˜åœ¨åˆ™å¡« NaNï¼ˆåç»­ fillnaï¼‰

&nbsp;   df\_merged = pd.merge(df\_price, df\_dividend, on=\['date', 'symbol'], how='left')



&nbsp;   # å¡«å……æ— äº‹ä»¶æ—¥çš„é»˜è®¤å€¼

&nbsp;   df\_merged\['è‚¡æƒç³»æ•°'] = df\_merged\['è‚¡æƒç³»æ•°'].fillna(1.0)

&nbsp;   df\_merged\['æ´¾æ¯ç³»æ•°'] = df\_merged\['æ´¾æ¯ç³»æ•°'].fillna(0.0)



&nbsp;   return df\_merged





**å›æµ‹å¼•æ“å±æ€§è¯´æ˜ï¼š**

.total\_capital                å¸æˆ·èµ·å§‹èµ„é‡‘ ï¼Œé»˜è®¤ä¸º1000000

.current\_capital            å¸æˆ·å½“å‰å¯ç”¨èµ„é‡‘

.positions                     å¸æˆ·å½“å‰æŒä»“ä¿¡æ¯

.buy\_commission        ä¹°å…¥äº¤æ˜“è´¹ç”¨ï¼Œé»˜è®¤ä¸º0.0005  

.sell\_commission         å–å‡ºäº¤æ˜“è´¹ç”¨ï¼Œé»˜è®¤ä¸º0.0015

.basis\_index                  åŸºå‡†æŒ‡æ•°ï¼Œé»˜è®¤ä¸ºæ²ªæ·±300

.portfolio\_value                   å½“å‰è´¦æˆ·æ€»èµ„äº§

.position\_value             å½“å‰è´¦æˆ·æŒä»“è‚¡ç¥¨å¸‚å€¼

.position\_days              è‚¡ç¥¨æŒä»“å‘¨æœŸï¼ˆäº¤æ˜“æ—¥å¤©æ•°ï¼‰ï¼Œé»˜è®¤ä¸º10å¤©ï¼Œåˆ°æœŸåä¼šè‡ªåŠ¨æ‰§è¡Œå–å‡ºäº¤æ˜“

.stock\_pool                   è‚¡ç¥¨æ± ï¼Œç”¨æˆ·å¯ä»¥åœ¨è‚¡ç¥¨æ± å­˜å…¥è¦è·Ÿè¸ªè§‚å¯Ÿçš„è‚¡ç¥¨ï¼Œæ˜¯åˆ—è¡¨æ ¼å¼

.trade\_status                æ¯æ—¥æˆäº¤è®°å½•ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§æŸ¥è¯¢ä»»ä½•ä¸€å¤©çš„è¯¦ç»†æˆäº¤è®°å½•

.stop\_loss\_return         å›ºå®šæ­¢æŸå¹…åº¦ï¼Œå¦‚è®¾ç½®ä¸º-20ï¼Œåˆ™åœ¨è‚¡ç¥¨æ”¶ç›˜ä»·ä½äºä¹°å…¥æˆæœ¬ä»·æ ¼çš„-20%æ—¶ï¼Œæ‰§è¡Œè‡ªåŠ¨å–å‡ºæ­¢æŸ

è¯´æ˜ï¼šæ‰€æœ‰å±æ€§ï¼Œç”¨æˆ·éƒ½å¯ä»¥é€šè¿‡context.çš„æ–¹å¼è¿›è¡Œé‡ç½®ä¿®æ”¹





**å›æµ‹å¼•æ“å‚æ•°è¯´æ˜ï¼š**

start\_date                   å›æµ‹å¼€å§‹æ—¥æœŸï¼ˆè¾“å…¥æ ¼å¼ä¸ºå­—ç¬¦ä¸²ï¼‰

end\_date                    å›æµ‹ç»“æŸæ—¥æœŸï¼ˆè¾“å…¥æ ¼å¼ä¸ºå­—ç¬¦ä¸²ï¼‰

data                            ç”¨æˆ·ä¼ å…¥çš„å›æµ‹æ•°æ®ï¼Œå¿…é¡»ç”¨ç»Ÿä¸€çš„åˆ—åä¸º:dateï¼Œsymbolï¼Œcloseï¼Œopenï¼Œhighï¼Œlowï¼Œå…¶ä»–åˆ—åå­—æ®µä¸ä½œè§„å®šã€‚

run\_func                     ç­–ç•¥å‡½æ•°çš„å‡½æ•°åï¼Œç”¨æˆ·ä¸èƒ½ä½¿ç”¨å…¶ä»–å‡½æ•°å

auto\_adjust               å£°æ˜ä¼ å…¥çš„dataæ˜¯å¦è¦è®¡ç®—å¤æƒæ”¶ç›Šï¼Œé»˜è®¤ä¸ºä¸è®¡ç®—ï¼Œç”¨æˆ·å¯ä»¥context.aute\_adjustçš„æ–¹å¼é‡ç½®å£°æ˜ï¼Œå»ºè®®ä½¿ç”¨å¤æƒæ•°æ®

context                       ç­–ç•¥å‡½æ•°è¦ä¼ å…¥çš„å‚æ•°ï¼Œä¸ºå…¨å±€å¯¹è±¡ï¼Œå»ºè®®ç”¨æˆ·ç»Ÿä¸€ä½¿ç”¨contextè¿™ä¸ªåå­—



**è°ƒç”¨äº¤æ˜“æŒ‡ä»¤è¯´æ˜ï¼š**

**1ã€context.buy\_trade(symbol, quantity, price\_type)ï¼Œsymbolï¼šè¦ä¹°å…¥çš„è‚¡ç¥¨ä»£ç ï¼Œquantityï¼šä¹°å…¥æ•°é‡ï¼ˆè‚¡ï¼‰ï¼Œprice\_typeï¼šä¹°å…¥çš„ä»·æ ¼ç±»å‹ï¼Œåˆ†close,open,price(å¦‚10.5)**

**2ã€context.sell\_trade( symbol, quantity, price\_type)ï¼Œquantityï¼šå–å‡ºè‚¡ç¥¨çš„æ•°é‡ï¼Œè¾“å…¥ä¸ºæ­£æ•°**

**3ã€context.trade\_quantity(symbol, quantity, price\_type)ï¼šæŒ‰ç›®æ ‡æŒä»“æ•°é‡æ‰§è¡Œäº¤æ˜“ï¼Œquantityä¸ºç›®æ ‡æŒä»“æ•°é‡ï¼Œå¦‚æœè¾“å…¥0ï¼Œåˆ™å¯¹è¯¥è‚¡ç¥¨è¿›è¡Œæ¸…ä»“**

**4ã€context.trade\_weight( symbol, weight, price\_type)ï¼šæŒ‰å¯ç”¨èµ„é‡‘åˆ†é…çš„æƒé‡ï¼ˆ0 åˆ° 1 ä¹‹é—´ï¼‰æ‰§è¡Œäº¤æ˜“ï¼Œweight=0è¡¨ç¤ºæ¸…ä»“è‚¡ç¥¨**

**5ã€context.trade\_total\_weight( symbol, weight, price\_type)ï¼šæŒ‰æ€»èµ„é‡‘åˆ†é…æƒé‡ï¼ˆ0 åˆ° 1 ä¹‹é—´ï¼‰,weight=0è¡¨ç¤ºæ¸…ä»“è‚¡ç¥¨**



**å…¶ä»–è¯´æ˜ ï¼š**

1ã€ç”±äºè®¡ç®—å¤æƒæ”¶ç›Šè¦ç”¨åˆ°akshareçš„æ•°æ®æ¥å£ï¼Œæœ‰æ—¶akshareçš„æ•°æ®æ¥å£ä¸ç¨³å®šï¼Œåˆ†çº¢æ•°æ®å¦‚æœè·å–å¤±è´¥ï¼Œä¼šå¯¼è‡´å›æµ‹ç»“æœå¤±çœŸï¼Œæ‰€ä»¥å»ºè®®ç”¨æˆ·ç”¨å¤æƒæ•°æ®è¿›è¡Œå›æµ‹ã€‚

2ã€ç”¨æˆ·åœ¨å†™ç­–ç•¥å‡½æ•°æ—¶ï¼Œå¯ä»¥ç”¨ä»»æ„æ•°æ®è¿›è¡Œåˆå¹¶å’Œé€‰è‚¡é€»è¾‘è®¡ç®—ï¼Œä½†ä¼ å…¥çš„å‚æ•°dataå¿…é¡»ç¬¦åˆä¸Šé¢çš„è§„å®šï¼Œè¦åŒ…å«dateï¼Œsymbolï¼Œcloseï¼Œopenï¼Œhighï¼Œlowè¿™6åˆ—çš„æ•°æ®ï¼Œå…¶ä»–æ•°æ®å¯ä»¥ä¸ä¼ å…¥ã€‚



**å›æµ‹å‡½æ•°ä»£ç ç¤ºä¾‹ï¼š**

    **def run\_func(context):**

	**â€œç”¨æˆ·å¯ä»¥ç”¨è‡ªå·±çš„ä»»æ„æ•°æ®å†™ç­–ç•¥é€»è¾‘â€**

        **context.stop\_loss\_return = -10  # å£°æ˜å›ºå®šæ­¢æŸå¹…åº¦**

        **context.position\_days = 120  # å£°æ˜æŒä»“å‘¨æœŸ**

        **try:**

            **current\_date = context.current\_date  #    è·å–å½“å‰æ—¥æœŸï¼Œè¿™å¥ä»£ç æ˜¯å›ºå®šæ ¼å¼ï¼Œå¿…é¡»è¦æœ‰**



            **trades = context.trade\_status # è·å–æˆäº¤è®°å½•ä¿¡æ¯**

            **daily\_trades = trades.get(current\_date,\[])   #  é€šè¿‡tradeså¯ä»¥è·å–ä»»æ„æ—¥æœŸçš„æˆäº¤è®°å½•ä¿¡æ¯**



            **today\_df = context.data\[context.data.date == current\_date] # è¿™å¥ä»£ç æ˜¯å›ºå®šæ ¼å¼ï¼Œå¿…é¡»è¦æœ‰ï¼Œç›®çš„æ˜¯æŠŠå…¨æ—¶æ®µæ•°æ®è½¬æ¢ä¸ºå›æµ‹å½“æ—¥çš„æ•°æ®** 



            **# æ‰“å°è°ƒè¯•ä¿¡æ¯**

            **print(current\_date.strftime('%Y-%m-%d'))**

            **print('ä»Šå¤©çš„æˆäº¤è‚¡ç¥¨ä¿¡æ¯', daily\_trades)**

            **# é€šè¿‡positionså¯¹è±¡ï¼Œä½¿ç”¨åˆ—è¡¨ç”Ÿæˆå¼çš„æ–¹æ³•è·å–ç›®å‰æŒä»“çš„è‚¡ç¥¨åˆ—è¡¨**

            **stock\_hold\_now = list(context.positions.keys())**

            **print(f'ç›®å‰æŒä»“çš„è‚¡ç¥¨:{stock\_hold\_now}')**

            **if not today\_df.empty:**

                **cond = today\_df\['buy\_price'].notna()  # é€‰ è‚¡æ¡ä»¶**

                **today\_df = today\_df\[cond]**

                **# æ•´ç†å‡ºå½“å¤©è¦ä¹°å…¥çš„è‚¡ç¥¨**

                **stock\_to\_buy = today\_df.symbol.tolist()**



                **# ç­‰æƒé‡ä¹°å…¥**

                **if len(stock\_to\_buy)>10:**

                    **weight = 0.99/len(stock\_to\_buy)**

                **else:**

                    **weight = 0.1**

                **# ä¹°å…¥**

                **print(f'éœ€è¦ä¹°å…¥å‡ºçš„è‚¡ç¥¨:æ€»å…±{len(stock\_to\_buy)}ä¸ªè‚¡ç¥¨,{stock\_to\_buy}')**

                **for stock in stock\_to\_buy:**

                    **context.trade\_total\_weight(stock,weight,'close')  # æ‰§è¡Œäº¤æ˜“æŒ‡ä»¤**



        **except Exception as e:**

            **print(f"Error in run\_func: {e}")**

å®ä¾‹åŒ–å¯¹è±¡ï¼Œæ‰§è¡Œå›æµ‹ï¼š

context = BacktestEngine(start_date, end_date, data, run_func, auto_adjust =False)
å…¶ä¸­å‚æ•°auto_adjustä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç­–ç•¥å‡½æ•°ä¸­é€šè¿‡context. auto_adjustçš„æ–¹å¼è¿›è¡Œå£°æ˜ä¿®æ”¹




